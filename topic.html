<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>topic - infiniware</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>

    <nav class="header">
        <div class="nav-brand">
            <a href="index.html" class="logo-text"><span>I</span>nfiniware</a>
        </div>
        <div class="nav-list">
            <a href="dashboard.html" class="nav-link">dashboard</a>
            <a href="#" class="nav-link" id="logout-btn">sign out</a>
        </div>
    </nav>

    <div class="container" style="max-width: 900px; margin-top: 40px;">
        
        <!-- Topic Header -->
        <div id="topic-header" class="card mb-lg">
            <div class="loading-spinner"></div>
        </div>

        <!-- Posts Container -->
        <div id="posts-container" class="flex-col gap-lg mb-xl">
            <div class="loading-spinner"></div>
        </div>

        <!-- Reply Form -->
        <div id="reply-section" class="card" style="display: none;">
            <h3 class="mb-md">post a reply</h3>
            <form id="reply-form" class="flex-col gap-md">
                <textarea id="reply-content" class="input-field" rows="6" placeholder="write your reply... markdown supported" required></textarea>
                
                <div class="input-group">
                    <label class="input-label">attach images (optional)</label>
                    <input type="file" id="reply-image-input" class="input-field" accept="image/*" multiple>
                    <div id="reply-image-previews" class="flex gap-md mt-md" style="flex-wrap: wrap;"></div>
                </div>

                <div class="flex gap-md align-center">
                    <button type="submit" class="btn btn-red" id="reply-submit-btn">post reply</button>
                </div>

                <p id="reply-error-msg" class="text-red" style="display: none; font-size: 0.85rem;"></p>
            </form>
        </div>

    </div>

    <script type="module">
        import { auth } from './firebase-init.js';
        import { initAuthListener, logout } from './auth.js';
        import { getTopic, subscribeToPosts, createPost, updatePost, deletePost } from './community.js';
        import { renderContent, validateImageFile, createImagePreview, formatDate } from './utils.js';

        const topicHeader = document.getElementById('topic-header');
        const postsContainer = document.getElementById('posts-container');
        const replySection = document.getElementById('reply-section');
        const replyForm = document.getElementById('reply-form');
        const replyContent = document.getElementById('reply-content');
        const replyImageInput = document.getElementById('reply-image-input');
        const replyImagePreviews = document.getElementById('reply-image-previews');
        const replyErrorMsg = document.getElementById('reply-error-msg');
        const replySubmitBtn = document.getElementById('reply-submit-btn');
        const logoutBtn = document.getElementById('logout-btn');

        let currentTopic = null;
        let currentUser = null;
        let replyImages = [];

        // Get topic ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const topicId = urlParams.get('id');

        if (!topicId) {
            window.location.href = 'dashboard.html';
        }

        initAuthListener((user) => {
            if (!user) {
                window.location.href = 'signin.html';
            } else if (!user.emailVerified) {
                window.location.href = 'verify-email.html';
            } else {
                currentUser = user;
                loadTopic();
                loadPosts();
            }
        });

        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => logout());
        }

        async function loadTopic() {
            try {
                currentTopic = await getTopic(topicId);
                if (!currentTopic) {
                    topicHeader.innerHTML = '<p class="text-red">topic not found.</p>';
                    return;
                }

                const dateStr = formatDate(currentTopic.created_at);
                const isOwner = currentUser && currentUser.uid === currentTopic.author_uid;

                topicHeader.innerHTML = `
                    <div class="flex justify-between align-start gap-md mb-md">
                        <div style="flex: 1;">
                            <div class="flex align-center gap-sm mb-sm">
                                ${currentTopic.pinned ? '<span class="text-red" style="font-size: 0.75rem;">pinned</span>' : ''}
                                ${currentTopic.locked ? '<span class="text-dim" style="font-size: 0.75rem;">locked</span>' : ''}
                                <h2 style="margin: 0;">${escapeHtml(currentTopic.title)}</h2>
                            </div>
                            <div class="flex align-center gap-md" style="font-size: 0.85rem;">
                                <span class="text-dim">by <a href="profile.html?uid=${currentTopic.author_uid}" class="text-white" style="text-decoration: none;">${escapeHtml(currentTopic.author_username)}</a></span>
                                <span class="text-dim">•</span>
                                <span class="text-dim">${dateStr}</span>
                            </div>
                        </div>
                        <a href="dashboard.html" class="btn btn-ghost" style="font-size: 0.85rem;">back</a>
                    </div>
                `;

                if (!currentTopic.locked) {
                    replySection.style.display = 'block';
                }
            } catch (error) {
                console.error("Error loading topic:", error);
                topicHeader.innerHTML = '<p class="text-red">failed to load topic.</p>';
            }
        }

        function loadPosts() {
            subscribeToPosts(topicId, (posts) => {
                postsContainer.innerHTML = '';

                if (posts.length === 0) {
                    postsContainer.innerHTML = '<p class="text-dim text-center">no posts yet.</p>';
                    return;
                }

                posts.forEach((post, index) => {
                    const isOwner = currentUser && currentUser.uid === post.author_uid;
                    const isFirstPost = index === 0;
                    const card = createPostCard(post, isOwner, isFirstPost);
                    postsContainer.appendChild(card);
                });
            });
        }

        function createPostCard(post, isOwner, isFirstPost) {
            const div = document.createElement('div');
            div.className = 'card';
            div.id = `post-${post.id}`;

            const dateStr = formatDate(post.created_at);
            const editedStr = post.updated_at && post.updated_at.getTime() !== post.created_at.getTime() 
                ? ' (edited)' : '';

            const mediaHtml = post.media_urls && post.media_urls.length > 0
                ? post.media_urls.map(url => `
                    <div class="post-media mt-md">
                        <img src="${url}" alt="attachment">
                    </div>
                `).join('')
                : '';

            div.innerHTML = `
                <div class="flex gap-md">
                    <div style="min-width: 50px;">
                        <a href="profile.html?uid=${post.author_uid}">
                            <div class="avatar-small" style="width: 50px; height: 50px; border-radius: 50%; background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                <span style="opacity: 0.5; font-size: 1.2rem;">${(post.author_username || 'U')[0].toUpperCase()}</span>
                            </div>
                        </a>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="flex justify-between align-center mb-sm">
                            <div class="flex align-center gap-sm">
                                <a href="profile.html?uid=${post.author_uid}" class="text-white" style="font-weight: 600; text-decoration: none;">
                                    ${escapeHtml(post.author_username)}
                                </a>
                                ${isFirstPost ? '<span class="text-red" style="font-size: 0.75rem;">topic starter</span>' : ''}
                            </div>
                            <div class="flex align-center gap-sm">
                                <span class="text-dim" style="font-size: 0.85rem;">${dateStr}${editedStr}</span>
                                ${isOwner ? `
                                    <button class="btn-text text-dim hover-white edit-post-btn" data-post-id="${post.id}" style="font-size: 0.85rem; margin-left: 10px;">edit</button>
                                    <button class="btn-text text-red hover-white delete-post-btn" data-post-id="${post.id}" style="font-size: 0.85rem; margin-left: 5px;">delete</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="post-content" id="post-content-${post.id}">
                            ${renderContent(post.content)}
                        </div>
                        ${mediaHtml}
                    </div>
                </div>
            `;

            // Edit functionality
            if (isOwner) {
                const editBtn = div.querySelector('.edit-post-btn');
                const deleteBtn = div.querySelector('.delete-post-btn');
                const contentDiv = div.querySelector(`#post-content-${post.id}`);

                editBtn.addEventListener('click', () => {
                    const currentText = post.content;
                    const textarea = document.createElement('textarea');
                    textarea.className = 'input-field';
                    textarea.value = currentText;
                    textarea.rows = 6;
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'btn btn-red mt-sm';
                    saveBtn.textContent = 'save';
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-ghost mt-sm';
                    cancelBtn.textContent = 'cancel';
                    cancelBtn.style.marginLeft = '10px';

                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(textarea);
                    contentDiv.appendChild(saveBtn);
                    contentDiv.appendChild(cancelBtn);

                    saveBtn.addEventListener('click', async () => {
                        const newContent = textarea.value.trim();
                        if (newContent.length < 10) {
                            alert('content must be at least 10 characters.');
                            return;
                        }
                        try {
                            await updatePost(post.id, newContent);
                            // Content will update via real-time listener
                        } catch (error) {
                            console.error("Error updating post:", error);
                            alert('failed to update post.');
                        }
                    });

                    cancelBtn.addEventListener('click', () => {
                        contentDiv.innerHTML = renderContent(post.content);
                    });
                });

                deleteBtn.addEventListener('click', async () => {
                    if (confirm('are you sure you want to delete this post?')) {
                        try {
                            await deletePost(post.id);
                            // Post will be removed via real-time listener
                        } catch (error) {
                            console.error("Error deleting post:", error);
                            alert('failed to delete post.');
                        }
                    }
                });
            }

            return div;
        }

        replyImageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            replyImages = [];
            replyImagePreviews.innerHTML = '';

            files.forEach((file, index) => {
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    replyErrorMsg.textContent = validation.error;
                    replyErrorMsg.style.display = 'block';
                    return;
                }

                replyImages.push(file);
                createImagePreview(file, (previewUrl) => {
                    if (previewUrl) {
                        const div = document.createElement('div');
                        div.style.position = 'relative';
                        div.style.width = '100px';
                        div.style.height = '100px';
                        div.style.borderRadius = '4px';
                        div.style.overflow = 'hidden';
                        div.style.border = '1px solid var(--clr-gray-dark)';
                        div.innerHTML = `
                            <img src="${previewUrl}" style="width:100%; height:100%; object-fit:cover;">
                            <button type="button" class="remove-image-btn" data-index="${index}" style="position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-size:12px;">×</button>
                        `;
                        replyImagePreviews.appendChild(div);

                        div.querySelector('.remove-image-btn').addEventListener('click', () => {
                            replyImages = replyImages.filter((_, i) => i !== index);
                            div.remove();
                        });
                    }
                });
            });
        });

        replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            replyErrorMsg.style.display = 'none';

            if (currentTopic.locked) {
                replyErrorMsg.textContent = "this topic is locked.";
                replyErrorMsg.style.display = 'block';
                return;
            }

            const content = replyContent.value.trim();
            if (content.length < 10) {
                replyErrorMsg.textContent = "reply must be at least 10 characters.";
                replyErrorMsg.style.display = 'block';
                return;
            }

            replySubmitBtn.textContent = 'posting...';
            replySubmitBtn.disabled = true;

            try {
                await createPost(topicId, content, null, replyImages);
                replyContent.value = '';
                replyImages = [];
                replyImageInput.value = '';
                replyImagePreviews.innerHTML = '';
                replySubmitBtn.textContent = 'post reply';
                replySubmitBtn.disabled = false;
            } catch (error) {
                console.error("Error creating reply:", error);
                replyErrorMsg.textContent = "failed to post reply. please try again.";
                replyErrorMsg.style.display = 'block';
                replySubmitBtn.textContent = 'post reply';
                replySubmitBtn.disabled = false;
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>
